<app-page-header [heading]="'Add trading strategy'" [icon]="'fa-magic'"></app-page-header>
<div class="alert alert-primary">
    <a href="http://bit.ly/2VmVCAw" target="_blank">Take a look at how strategies work</a>
</div>
<div *ngIf="creatingStrategiesInProgress || finishedCreatingStrategies">
    <div *ngFor="let strategyCreatedFor of strategiesCreatedFor" class="alert alert-success">
        Finished creating strategy for {{ strategyCreatedFor }}
    </div>
    <div *ngFor="let strategyNotCreatedFor of strategiesNotCreatedFor" class="alert alert-danger">
        Failed creating strategy for {{ strategyNotCreatedFor }}
    </div>
    <div *ngIf="!finishedCreatingStrategies" class="alert alert-warning">
        <i class="fa fa-refresh is-pending"></i>
        Creating strategies in progress
    </div>
    <div *ngIf="finishedCreatingStrategies">
        <a [routerLink]="'/trading-automation'" class="btn btn-success">
            Go back
        </a>
    </div>

</div>
<form #addStrategyExecutionForm="ngForm" *ngIf="!creatingStrategiesInProgress && !finishedCreatingStrategies">
    <div class="row">
        <div class="col-xs-12 col-xl-8">

            <div class="form-group">
                <label>Exchange name</label>
                <div class="form-control">
                    <strong>{{ exchangeName }}</strong>
                </div>
            </div>

            <div class="form-group">
                <label>Strategy</label>

                <select class="form-control" name="selectedStrategy" [(ngModel)]="selectedStrategyName">
                    <option *ngFor="let strategy of strategies" [value]="strategy.name">{{ strategy.name }}</option>
                </select>
            </div>

            <div class="form-group">
                <label *ngIf="isBuying()" for="currency-pair-typeahead">Currency pair (eg XRP/BTC if you want to buy XRP
                    and have less BTC)</label>
                <label *ngIf="isSelling()" for="currency-pair-typeahead">Currency pair (eg XRP/BTC if you want to sell
                    XRP and have more BTC)</label>
                <input name="currencyPair"
                       id="currency-pair-typeahead"
                       type="text"
                       class="form-control"
                       pattern="^[a-zA-Z]+/[a-zA-Z]+$"
                       required
                       [class.is-invalid]="currencyPairInput.invalid
                       && (currencyPairInput.dirty || currencyPairInput.touched)"
                       [(ngModel)]="currencyPair"
                       #currencyPairInput="ngModel"
                       (input)="$event.target.value = $event.target.value.toUpperCase()">
                <div class="invalid-feedback">Provide valid currency pair, eg. XXX/YYY</div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-xl-8">
            <div *ngIf="isBuying()" class="form-group">
                <label *ngIf="isUsingCounterCurrencyLimitAsFraction">
                    Buy limit (max {{counterCurrency()}} % to sell of current amount in wallet)
                </label>
                <label *ngIf="!isUsingCounterCurrencyLimitAsFraction">
                    Buy limit (max {{counterCurrency()}} amount to sell)
                </label>
                <div class="input-group">
                    <button (click)="useCounterCurrencyLimitAsFraction()" type="button"
                            class="btn mr-1"
                            [class.btn-secondary]="!isUsingCounterCurrencyLimitAsFraction"
                            [class.btn-success]="isUsingCounterCurrencyLimitAsFraction">
                        %
                    </button>
                    <button (click)="useCounterCurrencyLimitAsAmount()" type="button"
                            class="btn mr-1"
                            [class.btn-secondary]="isUsingCounterCurrencyLimitAsFraction"
                            [class.btn-success]="!isUsingCounterCurrencyLimitAsFraction">
                        123
                    </button>
                    <ng-container *ngIf="isUsingCounterCurrencyLimitAsFraction">
                        <input name="counterCurrencyPercentLimitForBuying"
                               type="text"
                               required
                               pattern="^\s*(?=.*[1-9])\d{1,2}(?:\.\d{1,2})?\s*$"
                               class="form-control"
                               [class.is-invalid]="counterCurrencyPercentLimitForBuyingInput.invalid
                                && (counterCurrencyPercentLimitForBuyingInput.dirty
                                || counterCurrencyPercentLimitForBuyingInput.touched)"
                               [(ngModel)]="counterCurrencyPercentLimitForBuying"
                               #counterCurrencyPercentLimitForBuyingInput="ngModel">
                        <div class="input-group-append">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="invalid-feedback">
                            Provide valid percent, eg. 2.5 (max 2 decimal places)
                        </div>
                    </ng-container>
                    <ng-container *ngIf="!isUsingCounterCurrencyLimitAsFraction">
                        <input name="counterCurrencyAmountLimitForBuying"
                               type="text"
                               pattern="^\s*(?=.*[1-9])\d*(?:\.\d{1,8})?\s*$"
                               required
                               class="form-control"
                               [class.is-invalid]="counterCurrencyAmountLimitForBuyingInput.invalid
                                && (counterCurrencyAmountLimitForBuyingInput.dirty
                                || counterCurrencyAmountLimitForBuyingInput.touched)"
                               [(ngModel)]="counterCurrencyAmountLimitForBuying"
                               #counterCurrencyAmountLimitForBuyingInput="ngModel">
                        <div class="invalid-feedback">
                            Provide valid amount, eg. 1.00045 (max 8 decimal places)
                        </div>
                    </ng-container>
                </div>
            </div>
            <div *ngIf="isSelling()" class="form-group">
                <label *ngIf="isUsingBaseCurrencyLimitAsFraction">
                    Max {{baseCurrency()}} % to sell of current amount in wallet
                </label>
                <label *ngIf="!isUsingBaseCurrencyLimitAsFraction">
                    Max {{baseCurrency()}} amount to sell
                </label>
                <div class="input-group">
                    <button (click)="useBaseCurrencyLimitAsFraction()"
                            type="button" class="btn mr-1"
                            [class.btn-secondary]="!isUsingBaseCurrencyLimitAsFraction"
                            [class.btn-success]="isUsingBaseCurrencyLimitAsFraction">
                        %
                    </button>
                    <button (click)="useBaseCurrencyLimitAsAmount()"
                            type="button" class="btn mr-1"
                            [class.btn-secondary]="isUsingBaseCurrencyLimitAsFraction"
                            [class.btn-success]="!isUsingBaseCurrencyLimitAsFraction">
                        123
                    </button>
                    <ng-container *ngIf="isUsingBaseCurrencyLimitAsFraction">
                        <input name="baseCurrencyFractionLimitForBuying"
                               type="text"
                               class="form-control"
                               required
                               pattern="^\s*(?=.*[1-9])\d{1,2}(?:\.\d{1,2})?\s*$"
                               [(ngModel)]="baseCurrencyPercentLimitForSelling"
                               #baseCurrencyPercentLimitForSellingInput="ngModel"
                               [class.is-invalid]="baseCurrencyPercentLimitForSellingInput.invalid
                                && (baseCurrencyPercentLimitForSellingInput.dirty
                                || baseCurrencyPercentLimitForSellingInput.touched)">
                        <div class="input-group-append">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="invalid-feedback">
                            Provide valid percent, eg. 2.5 (max 2 decimal places)
                        </div>
                    </ng-container>
                    <ng-container *ngIf="!isUsingBaseCurrencyLimitAsFraction">
                        <input name="baseCurrencyAmountLimitForSelling"
                               type="text"
                               class="form-control"
                               required
                               pattern="^\s*(?=.*[1-9])\d*(?:\.\d{1,8})?\s*$"
                               [(ngModel)]="baseCurrencyAmountLimitForSelling"
                               #baseCurrencyAmountLimitForSellingInput="ngModel"
                               [class.is-invalid]="baseCurrencyAmountLimitForSellingInput.invalid
                                && (baseCurrencyAmountLimitForSellingInput.dirty
                                || baseCurrencyAmountLimitForSellingInput.touched)">
                        <div class="invalid-feedback">
                            Provide valid amount, eg. 1.00045 (max 8 decimal places)
                        </div>
                    </ng-container>
                </div>
            </div>
            <div *ngIf="isBuying()" class="form-group">
                <label>Buy per order %</label>
                <div class="input-group">
                    <input name="counterCurrencyPercentForBuyingPerOrder"
                           type="text"
                           class="form-control"
                           required
                           pattern="^\s*(?=.*[1-9])\d{1,2}(?:\.\d{1,2})?\s*$"
                           [(ngModel)]="counterCurrencyPercentForBuyingPerOrder"
                           [class.is-invalid]="counterCurrencyPercentForBuyingPerOrderInput.invalid
                                && (counterCurrencyPercentForBuyingPerOrderInput.dirty
                                || counterCurrencyPercentForBuyingPerOrderInput.touched)"
                           #counterCurrencyPercentForBuyingPerOrderInput="ngModel">
                    <div class="input-group-append">
                        <span class="input-group-text">%</span>
                    </div>
                    <div class="invalid-feedback">
                        Provide valid percent, eg. 2.5 (max 2 decimal places)
                    </div>
                </div>
            </div>
            <div *ngIf="isSelling()" class="form-group">
                <label>Sell per order %</label>
                <div class="input-group">
                    <input name="baseCurrencyPercentForSellingPerOrder"
                           type="text"
                           required
                           pattern="^\s*(?=.*[1-9])\d{1,2}(?:\.\d{1,2})?\s*$"
                           class="form-control"
                           [(ngModel)]="baseCurrencyPercentForSellingPerOrder"
                           [class.is-invalid]="baseCurrencyPercentForSellingPerOrderInput.invalid
                                && (baseCurrencyPercentForSellingPerOrderInput.dirty
                                || baseCurrencyPercentForSellingPerOrderInput.touched)"
                           #baseCurrencyPercentForSellingPerOrderInput="ngModel">
                    <div class="input-group-append">
                        <span class="input-group-text">%</span>
                    </div>
                    <div class="invalid-feedback">
                        Provide valid percent, eg. 2.5 (max 2 decimal places)
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-xl-8">
            <app-buy-lower-and-lower-specific-parameters
                *ngIf="selectedStrategyName == 'BuyLowerAndLower'"
                (specificParametersChanged)="onSpecificParameters($event)">
            </app-buy-lower-and-lower-specific-parameters>
            <app-sell-higher-and-higher-specific-parameters
                *ngIf="selectedStrategyName == 'SellHigherAndHigher'"
                (specificParametersChanged)="onSpecificParameters($event)">
            </app-sell-higher-and-higher-specific-parameters>
            <app-sell-when-second-currency-grows-specific-parameters
                *ngIf="selectedStrategyName == 'SellWhenSecondCurrencyGrows'"
                (specificParametersChanged)="onSpecificParameters($event)">
            </app-sell-when-second-currency-grows-specific-parameters>
            <app-sell-now-parameters
                *ngIf="selectedStrategyName == 'SellNow'"
                (specificParametersChanged)="onSpecificParameters($event)">
            </app-sell-now-parameters>
            <app-buy-now-parameters
                *ngIf="selectedStrategyName == 'BuyNow'"
                (specificParametersChanged)="onSpecificParameters($event)">
            </app-buy-now-parameters>
        </div>
    </div>

    <div class="row">
        <div *ngIf="exchangeUserSelectionList.length > 1" class="col-xs-12 col-xl-8">

            <div class="form-group">
                <label>Select users</label>

                <div class="checkbox" *ngFor="let exchangeUserSelection of exchangeUserSelectionList">
                    <label>
                        <input type="checkbox" name="selectedExchangeUsers" [value]="true"
                               [(ngModel)]="exchangeUserSelection.checked"> {{ exchangeUserSelection.exchangeUser.name }}
                    </label>
                </div>
            </div>

        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-xl-8">
            <button type="submit" class="btn btn-primary add-strategy-execution"
                    (click)="showConfirmModal()"
                    [disabled]="!canMakeStrategyExecution()">
                Add strategy
            </button>
            <a [routerLink]="'/trading-automation'" class="btn btn-secondary">
                Cancel
            </a>
        </div>
    </div>
</form>

<ng-template #confirmContent let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Confirm adding new trading strategy</h4>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <p>
            Are you sure you want to add new trading strategy?
        </p>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="c('delete')">Yes</button>
        <button type="button" class="btn btn-secondary" (click)="d('Dismiss')">Dismiss</button>
    </div>
</ng-template>
